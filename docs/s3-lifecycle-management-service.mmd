sequenceDiagram
    actor User
    participant FE as Frontend
    participant S3Service as S3 Lifecycle API
    participant DB as Database
    participant AWS as AWS S3 SDK
    participant Cost as Cost Service

    Note over User, Cost: Fetch Bucket Recommendations
    User->>FE: View S3 Lifecycle page
    FE->>S3Service: GET /api/s3/recommendations
    S3Service->>DB: Get cached recommendations
    
    alt Fresh Scan Needed
        S3Service->>AWS: list_buckets()
        AWS-->>S3Service: Bucket list
        
        loop For Each Bucket
            S3Service->>AWS: get_bucket_lifecycle_configuration()
            S3Service->>AWS: list_objects_v2() [sample]
            S3Service->>AWS: get_bucket_metrics()
            AWS-->>S3Service: Bucket metadata
            
            S3Service->>S3Service: Analyze access patterns
            S3Service->>Cost: Calculate savings
            Cost-->>S3Service: Estimated savings
            
            alt Should Recommend
                S3Service->>DB: UPSERT recommendation
            end
        end
    end
    
    S3Service-->>FE: 200 OK {recommendations}

    Note over User, Cost: Apply Lifecycle Policy
    User->>FE: Apply tier change (bucket-id)
    FE->>S3Service: POST /api/s3/buckets/{id}/lifecycle
    S3Service->>DB: Get recommendation
    DB-->>S3Service: Target tier details
    
    S3Service->>AWS: put_bucket_lifecycle_configuration(Rules)
    
    alt Success
        AWS-->>S3Service: 200 OK
        S3Service->>DB: UPDATE status='applied'
        S3Service->>DB: Log action audit
        S3Service-->>FE: 200 OK {message}
    else Error
        AWS-->>S3Service: Error
        S3Service-->>FE: 500 Error
    end